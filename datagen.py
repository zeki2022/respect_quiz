#!/usr/bin/env python3
import pandas as pd
import json
import argparse
import os
import sys

# ==========================================
# ğŸ”§ é…ç½®åŒºåŸŸï¼šåœ¨è¿™é‡Œå®šä¹‰ä½ çš„å­¦ç§‘æ˜ å°„å…³ç³»
# ==========================================
BATCH_CONFIG = [
    {
        "input": "math.xlsx", 
        "output": "subjects/math/data.js", 
        "var_name": "MATH_DATA"
    },
    {
        "input": "econ.xlsx", 
        "output": "subjects/econ/data.js", 
        "var_name": "ECON_DATA"
    },
    # æœªæ¥åªéœ€åœ¨è¿™é‡ŒåŠ ä¸€è¡Œï¼š
    # { "input": "physics.xlsx", "output": "subjects/physics/data.js", "var_name": "PHYSICS_DATA" },
]
# ==========================================

def generate_data(input_file, output_file, var_name=None):
    # æ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(input_file):
        print(f"âš ï¸ è·³è¿‡: æ‰¾ä¸åˆ°æ–‡ä»¶ '{input_file}'")
        return

    print(f"ğŸ”„ æ­£åœ¨å¤„ç†: {input_file} -> {output_file} ...")
    
    try:
        df = pd.read_excel(input_file, dtype={'year': str, 'quest#': str, 'quest file': str, 'path': str})
    except Exception as e:
        print(f"âŒ è¯»å–å¤±è´¥: {e}")
        return

    df.columns = df.columns.str.strip()
    
    # å¦‚æœæ²¡æœ‰æŒ‡å®š var_nameï¼Œå°è¯•è‡ªåŠ¨æ¨æ–­
    if not var_name:
        if "econ" in output_file.lower(): var_name = "ECON_DATA"
        elif "phys" in output_file.lower(): var_name = "PHYSICS_DATA"
        else: var_name = "MATH_DATA"

    papers_list = []
    
    # åˆ†ç»„é€»è¾‘ (æŒ‰è¯•å· qp åˆ†ç»„)
    if 'qp' not in df.columns:
        print(f"âŒ é”™è¯¯: {input_file} ç¼ºå°‘ 'qp' åˆ—")
        return

    grouped = df.groupby('qp')
    for qp_name, group in grouped:
        first_row = group.iloc[0]
        paper_obj = {
            "id": qp_name,
            "year": str(first_row['year']),
            "subject": str(first_row['2nd sub']),
            "paperName": f"{qp_name}.pdf".replace(".pdf.pdf", ".pdf").upper(),
            "questions": []
        }
        
        for _, row in group.iterrows():
            q_num = str(row['quest#'])
            q_file = str(row['quest file'])
            base_path = str(row['path'])
            
            # æ™ºèƒ½æ¸…æ´—è·¯å¾„ï¼šä¸ç®¡ Excel é‡Œå†™æ²¡å†™ subjects/xxx/ï¼Œéƒ½æ¸…æ´—å¹²å‡€
            clean_path = base_path
            # ç§»é™¤å¸¸è§å‰ç¼€
            prefixes = ["subjects/math/", "subjects/econ/", "subjects/physics/", 
                        "subjects/math", "subjects/econ", "subjects/physics"]
            for p in prefixes:
                clean_path = clean_path.replace(p, "")
            
            if clean_path.startswith("/"): clean_path = clean_path[1:]

            full_url = ""
            title_desc = ""
            
            # åˆ¤æ–­æ˜¯å¦æ˜¯æ–°é¢˜
            # å‡è®¾ Excel é‡Œæœ‰ä¸€åˆ—å« 'new'ï¼Œå¦‚æœå¡«äº† 'y'ï¼Œå°±åœ¨æ ‡é¢˜å‰åŠ ä¸ªæ ‡è®°
            is_new = str(row.get('new', '')).lower() == 'y'
            
            if q_file != "nan" and q_file.strip() != "":
                if not clean_path.endswith("/"): clean_path += "/"
                full_url = f"{clean_path}{q_file}"
                title_desc = f"Question {q_num}"
            else:
                title_desc = "é¢˜ç›®æš‚æœªå½•å…¥"

            q_data = {
                "qNum": q_num,
                "title": title_desc, 
                "url": full_url
            }
            
            # å¦‚æœæ˜¯æ–°é¢˜ï¼Œå¯ä»¥åŠ ä¸ªæ ‡è®°å­—æ®µï¼ˆå‰ç«¯éœ€é…åˆä¿®æ”¹æ‰èƒ½æ˜¾ç¤ºï¼Œè¿™é‡Œå…ˆå­˜æ•°æ®ï¼‰
            if is_new:
                q_data["isNew"] = True

            paper_obj["questions"].append(q_data)
            
        papers_list.append(paper_obj)
    
    papers_list.sort(key=lambda x: x['year'], reverse=True)

    js_content = f"// Auto-generated by datagen.py\n// Source: {input_file}\n\nconst {var_name} = "
    js_content += json.dumps(papers_list, indent=4, ensure_ascii=False)
    js_content += ";"

    try:
        # è‡ªåŠ¨åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        os.makedirs(os.path.dirname(output_file), exist_ok=True)
        
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(js_content)
        print(f"âœ… æˆåŠŸ! {var_name} å·²æ›´æ–°ã€‚")
    except Exception as e:
        print(f"âŒ å†™å…¥å¤±è´¥: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Auto-generate data.js for Respect Quiz")
    parser.add_argument("-i", "--input", help="Input Excel file")
    parser.add_argument("-o", "--output", help="Output JS file")
    
    args = parser.parse_args()
    
    # é€»è¾‘åˆ†æ”¯ï¼š
    if args.input and args.output:
        # æ¨¡å¼ 1: å‘½ä»¤è¡ŒæŒ‡å®šäº†æ–‡ä»¶ï¼Œåªå¤„ç†è¿™ä¸€ä¸ª
        generate_data(args.input, args.output)
    else:
        # æ¨¡å¼ 2: æ²¡ç»™å‚æ•°ï¼Œè¿›å…¥ã€è‡ªåŠ¨æ‰¹å¤„ç†æ¨¡å¼ã€‘
        print("ğŸš€ å¼€å§‹æ‰¹é‡æ›´æ–°æ‰€æœ‰å­¦ç§‘æ•°æ®...\n")
        for task in BATCH_CONFIG:
            generate_data(task["input"], task["output"], task["var_name"])
        print("\nâœ¨ æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•!")