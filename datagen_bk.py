#!/usr/bin/env python3
import pandas as pd
import json
import argparse
import os
import sys

# ==========================================
# ğŸ”§ é…ç½®åŒºåŸŸ
# ==========================================
BATCH_CONFIG = [
    {
        "key": "math", # ç”¨äºå‘½ä»¤è¡ŒåŒ¹é…çš„æ ‡è¯†
        "input": "math.xlsx", 
        "output": "subjects/math/data.js", 
        "var_name": "MATH_DATA"
    },
    {
        "key": "econ",
        "input": "econ.xlsx", 
        "output": "subjects/econ/data.js", 
        "var_name": "ECON_DATA"
    },
    {
        "key": "phys",
        "input": "physics.xlsx", 
        "output": "subjects/phys/data.js", 
        "var_name": "PHYSICS_DATA" 
    },
]
# ==========================================

def generate_data(input_file, output_file, var_name=None):
    # æ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(input_file):
        print(f"âš ï¸  è·³è¿‡: æ‰¾ä¸åˆ°æ–‡ä»¶ '{input_file}'")
        return

    print(f"ğŸ”„ æ­£åœ¨å¤„ç†: {input_file} -> {output_file} ...")
    
    try:
        df = pd.read_excel(input_file, dtype={'year': str, 'quest#': str, 'quest file': str, 'path': str})
    except Exception as e:
        print(f"âŒ è¯»å–å¤±è´¥: {e}")
        return

    df.columns = df.columns.str.strip()
    
    if not var_name:
        if "econ" in output_file.lower(): var_name = "ECON_DATA"
        elif "phys" in output_file.lower(): var_name = "PHYSICS_DATA"
        else: var_name = "MATH_DATA"

    papers_list = []
    
    if 'qp' not in df.columns:
        print(f"âŒ é”™è¯¯: {input_file} ç¼ºå°‘ 'qp' åˆ—")
        return

    grouped = df.groupby('qp')
    for qp_name, group in grouped:
        first_row = group.iloc[0]
        paper_obj = {
            "id": qp_name,
            "year": str(first_row['year']),
            "subject": str(first_row['2nd sub']),
            "paperName": f"{qp_name}.pdf".replace(".pdf.pdf", ".pdf").upper(),
            "questions": []
        }
        
        for _, row in group.iterrows():
            q_num = str(row['quest#'])
            q_file = str(row['quest file'])
            base_path = str(row['path'])
            
            clean_path = base_path
            prefixes = ["subjects/math/", "subjects/econ/", "subjects/phys/", 
                        "subjects/math", "subjects/econ", "subjects/phys"]
            for p in prefixes:
                clean_path = clean_path.replace(p, "")
            
            if clean_path.startswith("/"): clean_path = clean_path[1:]

            full_url = ""
            title_desc = ""
            
            is_new = str(row.get('new', '')).lower() == 'y'
            
            if q_file != "nan" and q_file.strip() != "":
                if not clean_path.endswith("/"): clean_path += "/"
                full_url = f"{clean_path}{q_file}"
                title_desc = f"Question {q_num}"
            else:
                title_desc = "é¢˜ç›®æš‚æœªå½•å…¥"

            q_data = {
                "qNum": q_num,
                "title": title_desc, 
                "url": full_url
            }
            
            if is_new:
                q_data["isNew"] = True

            paper_obj["questions"].append(q_data)
            
        papers_list.append(paper_obj)
    
    papers_list.sort(key=lambda x: x['year'], reverse=True)

    js_content = f"// Auto-generated by datagen.py\n// Source: {input_file}\n\nconst {var_name} = "
    js_content += json.dumps(papers_list, indent=4, ensure_ascii=False)
    js_content += ";"

    try:
        os.makedirs(os.path.dirname(output_file), exist_ok=True)
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(js_content)
        print(f"âœ… æˆåŠŸ! {var_name} å·²æ›´æ–°ã€‚\n")
    except Exception as e:
        print(f"âŒ å†™å…¥å¤±è´¥: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Auto-generate data.js for Respect Quiz")
    
    # äº’æ–¥ç»„ï¼šè¦ä¹ˆç”¨ -i/-o è‡ªå®šä¹‰æ¨¡å¼ï¼Œè¦ä¹ˆç”¨å¿«æ·æ–¹å¼æ¨¡å¼
    group = parser.add_argument_group('Shortcuts')
    group.add_argument("-m", "--math", action="store_true", help="Update Mathematics only")
    group.add_argument("-e", "--econ", action="store_true", help="Update Economics only")
    group.add_argument("-p", "--phys", action="store_true", help="Update Physics only")
    
    parser.add_argument("-i", "--input", help="Custom Input Excel file")
    parser.add_argument("-o", "--output", help="Custom Output JS file")
    
    args = parser.parse_args()
    
    # æ–¹å¼äºŒï¼šå®Œå…¨è‡ªå®šä¹‰è·¯å¾„æ¨¡å¼ (ä¼˜å…ˆçº§æœ€é«˜)
    if args.input and args.output:
        print(f"ğŸ”§ è‡ªå®šä¹‰æ¨¡å¼: {args.input} -> {args.output}")
        generate_data(args.input, args.output)
        sys.exit(0)

    # æ–¹å¼ä¸‰ï¼šå¿«æ·å‚æ•°æ¨¡å¼
    # æ”¶é›†ç”¨æˆ·æƒ³è¦æ›´æ–°çš„å­¦ç§‘ key
    targets = []
    if args.math: targets.append("math")
    if args.econ: targets.append("econ")
    if args.phys: targets.append("phys")

    if targets:
        # å¦‚æœç”¨æˆ·æŒ‡å®šäº†æŸäº›å­¦ç§‘ï¼Œåªæ›´æ–°è¿™äº›
        print(f"ğŸ¯ æŒ‡å®šæ›´æ–°æ¨¡å¼: {', '.join(targets).upper()}\n")
        for task in BATCH_CONFIG:
            if task["key"] in targets:
                generate_data(task["input"], task["output"], task["var_name"])
    else:
        # æ–¹å¼ä¸€ï¼šé»˜è®¤æ¨¡å¼ï¼ˆä»€ä¹ˆå‚æ•°éƒ½æ²¡åŠ ï¼‰ï¼Œæ›´æ–°å…¨éƒ¨
        print("ğŸš€ é»˜è®¤æ¨¡å¼ï¼šæ‰¹é‡æ›´æ–°æ‰€æœ‰å­¦ç§‘...\n")
        for task in BATCH_CONFIG:
            generate_data(task["input"], task["output"], task["var_name"])
        print("âœ¨ æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•!")