#!/usr/bin/env python3
import pandas as pd
import json
import argparse
import os
import sys

def generate_data(input_file, output_file):
    print(f"æ­£åœ¨è¯»å– Excel æ–‡ä»¶: {input_file} ...")
    
    try:
        # è¯»å– Excelï¼Œå¼ºåˆ¶å°†æŸäº›åˆ—ä½œä¸ºå­—ç¬¦ä¸²å¤„ç†ï¼Œé˜²æ­¢å¹´ä»½å˜æˆæ•°å­—
        df = pd.read_excel(input_file, dtype={
            'year': str, 
            'quest#': str, 
            'quest file': str,
            'path': str
        })
    except FileNotFoundError:
        print(f"âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ–‡ä»¶ '{input_file}'")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ è¯»å– Excel å¤±è´¥: {e}")
        sys.exit(1)

    # æ•°æ®æ¸…æ´—ï¼šå»é™¤åˆ—åçš„ç©ºæ ¼
    df.columns = df.columns.str.strip()
    
    # æ£€æŸ¥å¿…é¡»çš„åˆ—æ˜¯å¦å­˜åœ¨
    required_columns = ['subject', 'year', '2nd sub', 'qp', 'quest#', 'path']
    for col in required_columns:
        if col not in df.columns:
            print(f"âŒ Excel ç¼ºå°‘å¿…è¦çš„åˆ—: {col}")
            sys.exit(1)

    # ç»“æœåˆ—è¡¨
    papers_list = []

    # æŒ‰è¯•å· (qp) åˆ†ç»„
    grouped = df.groupby('qp')

    for qp_name, group in grouped:
        # è·å–è¯•å·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå–è¯¥ç»„ç¬¬ä¸€è¡Œçš„æ•°æ®ï¼‰
        first_row = group.iloc[0]
        
        paper_obj = {
            "id": qp_name,
            "year": str(first_row['year']),
            "subject": str(first_row['2nd sub']),
            # å‡è®¾ Excel é‡Œçš„ qp åªæ˜¯æ–‡ä»¶åä¸å«åç¼€ï¼Œè‡ªåŠ¨è¡¥ .pdf
            # å¦‚æœ Excel é‡Œå·²ç»æœ‰ .pdfï¼Œè¿™è¡Œä»£ç ä¹Ÿæ²¡é—®é¢˜ï¼Œä¸‹é¢çš„ replace ä¼šå¤„ç†
            "paperName": f"{qp_name}.pdf".replace(".pdf.pdf", ".pdf").upper(),
            "questions": []
        }

        # éå†è¯¥è¯•å·ä¸‹çš„æ‰€æœ‰é¢˜ç›®
        for _, row in group.iterrows():
            q_num = str(row['quest#'])
            q_file = str(row['quest file'])
            base_path = str(row['path'])
            
            # --- æ ¸å¿ƒé€»è¾‘ï¼šç”Ÿæˆ URL ---
            # 1. æ¸…æ´— base_pathï¼Œæˆ‘ä»¬è¦çš„æ˜¯ index.html (åœ¨ subjects/math/) ç›¸å¯¹çš„è·¯å¾„
            # Excel é‡Œçš„ path æ˜¯: subjects/math/2025/M/...
            # æˆ‘ä»¬éœ€è¦å˜æˆ: 2025/M/...
            # æ‰€ä»¥æŠŠå‰é¢çš„ 'subjects/math/' æ›¿æ¢ä¸ºç©º
            clean_path = base_path.replace("subjects/math/", "").replace("subjects/math", "")
            if clean_path.startswith("/"):
                clean_path = clean_path[1:]

            # 2. åˆ¤æ–­æ˜¯å¦æœ‰è§£é¢˜æ–‡ä»¶
            full_url = ""
            title_desc = "" # é»˜è®¤ä¸ºç©ºï¼Œå¦‚æœ excel ä»¥ååŠ äº† title åˆ—å¯ä»¥è¯»è¿™é‡Œ

            if q_file != "nan" and q_file.strip() != "":
                # æœ‰æ–‡ä»¶åï¼Œæ‹¼æ¥è·¯å¾„
                # ç¡®ä¿è·¯å¾„æœ«å°¾æœ‰ /
                if not clean_path.endswith("/"):
                    clean_path += "/"
                full_url = f"{clean_path}{q_file}"
                # è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰æœ‰é¢˜ç›®æ—¶çš„é»˜è®¤æ ‡é¢˜
                title_desc = f"Question {q_num}" 
            else:
                # æ²¡æœ‰æ–‡ä»¶å
                title_desc = "é¢˜ç›®æš‚æœªå½•å…¥"

            q_obj = {
                "qNum": q_num,
                "title": title_desc, 
                "url": full_url
            }
            
            paper_obj["questions"].append(q_obj)

        # å¯¹é¢˜ç›®æŒ‰é¢˜å·æ’åº (å¯é€‰ï¼Œé˜²æ­¢ Excel ä¹±åº)
        # paper_obj["questions"].sort(key=lambda x: int(x['qNum']) if x['qNum'].isdigit() else 999)

        papers_list.append(paper_obj)

    # å¯¹è¯•å·æŒ‰å¹´ä»½å€’åºæ’åˆ— (æ–°çš„åœ¨å‰é¢)
    papers_list.sort(key=lambda x: x['year'], reverse=True)

    # ç”Ÿæˆ JS å†…å®¹
    js_content = f"// Auto-generated by datagen.py\n// Source: {input_file}\n\nconst MATH_DATA = "
    js_content += json.dumps(papers_list, indent=4, ensure_ascii=False)
    js_content += ";"

    # å†™å…¥æ–‡ä»¶
    try:
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(js_content)
        print(f"âœ… æˆåŠŸ! å·²ç”Ÿæˆæ•°æ®æ–‡ä»¶: {output_file}")
        print(f"ğŸ“Š å…±å¤„ç†äº† {len(papers_list)} å¥—è¯•å·ï¼ŒåŒ…å« {len(df)} æ¡é¢˜ç›®è®°å½•ã€‚")
    except Exception as e:
        print(f"âŒ å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Convert Excel to data.js for Respect Quiz")
    parser.add_argument("-i", "--input", default="math.xlsx", help="Input Excel file (default: math.xlsx)")
    parser.add_argument("-o", "--output", default="subjects/math/data.js", help="Output JS file (default: subjects/math/data.js)")
    
    args = parser.parse_args()
    
    generate_data(args.input, args.output)