<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Q6: Waterslide Energy</title>
    
    <link rel="stylesheet" href="../../../../../common/css/style.css">
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { padding-top: 60px; padding-bottom: 40px; background-color: #f4f7f6; max-width: none !important; }
        .container { width: 96%; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 380px; gap: 20px; align-items: start; }
        @media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .back-arrow { position: fixed; top: 15px; left: 15px; z-index: 9999; width: 40px; height: 40px; background: rgba(255,255,255,0.9); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; text-decoration: none; color: #333; font-size: 24px; font-weight: bold; font-family: sans-serif; line-height: 1; cursor: pointer; }
        
        /* 画布防塌陷：强制高度 */
        .canvas-container { 
            width: 100%; height: 0; 
            padding-bottom: 55%; 
            position: relative; background: #fff; border: 1px solid #ddd; 
            border-radius: 8px; margin-bottom: 15px; overflow:hidden; 
            min-height: 350px; 
        }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .controls { display: flex; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; align-items: center; border:1px solid #eee;}
        button.action-btn { background-color: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size:14px;}
        
        .solution-panel { max-height: 85vh; overflow-y: auto; padding-right:5px;}
        .step-box { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; background: #fff; border-radius: 8px; border-left: 4px solid #ccc; transition: all 0.3s; opacity: 0.7; }
        .step-box.active { border-left: 4px solid #3498db; background: #f0f9ff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); opacity: 1; transform: translateX(-5px); }
        .step-title { font-weight: bold; color: #2c3e50; margin-bottom: 5px; display: block; font-size: 15px; border-bottom: 1px dashed #ddd; padding-bottom:5px;}
        .math-eq { font-family: 'Consolas', monospace; color: #c0392b; background: #f9f9f9; border: 1px solid #eee; padding: 2px 6px; border-radius: 4px; margin: 3px 0; display: inline-block; font-size: 13px; }
        
        /* 堆叠式能量条 (Stacked Bar) */
        .energy-bar-container { 
            height: 20px; background: #eee; border-radius: 10px; overflow: hidden; display: flex; margin-top: 10px; 
            border: 1px solid #ccc;
        }
        .bar-pe { background: #e74c3c; height: 100%; width: 100%; transition: width 0.1s; } /* 初始全红 */
        .bar-ke { background: #2ecc71; height: 100%; width: 0%; transition: width 0.1s; }
        .bar-work { background: #95a5a6; height: 100%; width: 0%; transition: width 0.1s; }
        
        .legend { font-size: 12px; color: #666; margin-top:5px; display:flex; gap:15px; justify-content:center;}
        .dot { width:10px; height:10px; display:inline-block; border-radius:50%; margin-right:4px;}

        .orig-img { max-width: 100%; display: block; margin: 10px 0; border-radius: 4px; border:1px solid #eee; }
        .problem-text { font-size: 15px; line-height: 1.6; color: #333; }
    </style>
</head>
<body>

    <a href="javascript:history.back()" class="back-arrow">‹</a>

    <div class="container">
        <!-- 左侧：动画区 -->
        <div class="left-col">
            <div class="card">
                <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">9709 Math / Mechanics / Q6</h3>
                
                <div class="problem-text" style="background:#e8f4fd; padding:15px; border-left:4px solid #3498db; margin-bottom:15px; font-size:14px; color:#333;">
                    <div class="orig-img-container">
                        <img src="q6_1.png" class="orig-img" onerror="this.style.display='none'">
                    </div>
                    
                    <p>The diagram shows the vertical cross-section $ABC$ of a rough waterslide. The section $AB$ is a straight line of length $5$ m inclined at an angle of $\theta$ to the horizontal, where $\sin\theta = 0.8$. The point $B$ is $2.5$ m above the level of $C$.</p>
                    <p>A man of mass $80$ kg, modelled as a particle, slides down the waterslide, starting from rest at $A$. The coefficient of friction between the man and the straight section of the waterslide is $0.1$.</p>
                    
                    <strong>(a)</strong> Find the speed of the man at $B$. [5]<br><br>
                    
                    <div class="orig-img-container">
                        <img src="q6_2.png" class="orig-img" onerror="this.style.display='none'">
                    </div>
                    <p>It is given that there is no change in the speed of the man when passing through $B$ and that his speed at $C$ is $11$ ms$^{-1}$.</p>
                    
                    <strong>(b)</strong> Find the work done against the resistance force as the man moves from $B$ to $C$. [4]
                </div>

                <div style="margin-top:20px; border-top:2px solid #eee; padding-top:20px;">
                    <h4 style="margin:0 0 10px 0; color:#3498db;">Simulation</h4>
                    <div class="canvas-container">
                        <canvas id="simCanvas"></canvas>
                    </div>

                    <!-- 堆叠式能量条 -->
                    <div class="energy-bar-container">
                        <div class="bar-pe" id="barPE"></div>
                        <div class="bar-ke" id="barKE"></div>
                        <div class="bar-work" id="barWork"></div>
                    </div>
                    <div class="legend">
                        <span><span class="dot" style="background:#e74c3c"></span>Potential Energy (PE)</span>
                        <span><span class="dot" style="background:#2ecc71"></span>Kinetic Energy (KE)</span>
                        <span><span class="dot" style="background:#95a5a6"></span>Work vs Resistance</span>
                    </div>

                    <div class="controls" style="margin-top:15px;">
                        <button class="action-btn" onclick="startSim()" id="btnStart">Start Slide</button>
                        <button class="action-btn" style="background:#95a5a6" onclick="resetSim()">Reset</button>
                        
                        <div style="flex:1; display:flex; align-items:center; justify-content:flex-end; gap:10px;">
                            <span style="font-weight:bold; color:#555; font-size:12px;">Speed:</span>
                            <input type="range" id="speedRange" min="0.1" max="2.0" step="0.1" value="0.5" style="width:100px; cursor:pointer;">
                            <span id="speedVal" style="width:30px; text-align:right; font-size:12px;">0.5x</span>
                        </div>
                        
                        <div style="width:100%; text-align:right; margin-top:5px; font-weight:bold; color:#2c3e50; font-size:16px;">
                            v = <span id="velDisplay">0.00</span> m/s
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：解题步骤 -->
        <div class="right-col">
            <div class="card solution-panel">
                <div class="data-summary" style="background: #fff8e1; border: 1px solid #ffe0b2; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 13px; color: #d35400;">
                    <strong>Step 0: Extract Data</strong><br>
                    Mass $m = 80$ kg<br>
                    <strong>Section AB:</strong> $L=5$m, $\sin\theta=0.8$, $\mu=0.1$<br>
                    <strong>Section BC:</strong> Vertical drop $h=2.5$m
                </div>

                <div id="step1" class="step-box">
                    <span class="step-title">Part (a): Speed at B</span>
                    <strong>Method: Work-Energy Principle</strong><br>
                    1. Height drop $h_{AB} = 5 \sin\theta = 4$ m.<br>
                    PE Loss $= mgh = 3200$ J.<br><br>
                    2. Work against Friction:<br>
                    $R = mg\cos\theta = 800(0.6) = 480$ N<br>
                    $F = \mu R = 48$ N<br>
                    $WD_{AB} = 48 \times 5 = 240$ J<br><br>
                    3. Conservation:<br>
                    $KE_B = PE_{loss} - WD = 2960$ J<br>
                    $\frac{1}{2}(80)v^2 = 2960$<br>
                    $v = \sqrt{74} \approx \mathbf{8.60 \text{ m/s}}$
                </div>

                <div id="step2" class="step-box" style="border-left-color: #e67e22;">
                    <span class="step-title" style="color:#e67e22;">Part (b): Work Done (B to C)</span>
                    <strong>1. Energy Balance:</strong><br>
                    $PE_{loss} + KE_{start} = KE_{end} + WD$<br>
                    (Total E before = Total E after + Loss)<br><br>
                    <strong>2. Calculate Values:</strong><br>
                    $PE_{loss} = mgh = 80(10)(2.5) = 2000$ J<br>
                    $KE_B = 2960$ J<br>
                    $KE_C = \frac{1}{2}(80)(11)^2 = 4840$ J<br>
                    $\Delta KE = 4840 - 2960 = 1880$ J (Gain)<br><br>
                    <strong>3. Solve:</strong><br>
                    $2000 = 1880 + WD$<br>
                    $WD = \mathbf{120 \text{ J}}$
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        
        const mass = 80;
        const distAB = 5;
        const vB = Math.sqrt(74); 
        const vC = 11;
        const a1 = 7.4;
        
        let simState = 'RESET';
        let animId;
        let currentDist = 0;
        let currentVel = 0;
        let timeScale = 0.5;
        let path = {};
        
        document.getElementById('speedRange').addEventListener('input', function(e) {
            timeScale = parseFloat(e.target.value);
            document.getElementById('speedVal').innerText = timeScale.toFixed(1) + "x";
        });

        function resize() {
            if(!canvas.parentElement) return;
            canvas.width = canvas.parentElement.clientWidth;
            // 强制兜底高度，防止白屏
            canvas.height = canvas.parentElement.clientHeight || 400;
            initPath();
            if(simState !== 'RUNNING') drawFrame();
        }
        window.addEventListener('resize', resize);
        window.addEventListener('load', resize); // 关键：加载后重绘

        function initPath() {
            const w = canvas.width;
            const h = canvas.height;
            const p = w * 0.05;
            
            const Ax = p + 20; const Ay = h * 0.1;
            const Bx = w * 0.5; const By = h * 0.6;
            const Cx = w - p - 20; const Cy = h * 0.85;
            
            path = { Ax, Ay, Bx, By, Cx, Cy };
        }

        function startSim() {
            if(simState === 'RUNNING') return;
            simState = 'RUNNING';
            document.getElementById('btnStart').disabled = true;
            let lastTime = performance.now();
            function loop(now) {
                if(simState !== 'RUNNING') return;
                let dt = (now - lastTime) / 1000; lastTime = now; if(dt > 0.1) dt = 0.1;
                update(dt * timeScale);
                drawFrame();
                animId = requestAnimationFrame(loop);
            }
            animId = requestAnimationFrame(loop);
        }

        function resetSim() {
            cancelAnimationFrame(animId); simState = 'RESET'; currentDist = 0; currentVel = 0;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').innerText = "Start Slide";
            document.querySelectorAll('.step-box').forEach(el => el.classList.remove('active'));
            updateBars(); drawFrame();
        }

        function update(dt) {
            if (currentDist < distAB) {
                highlightStep(1);
                currentVel += a1 * dt; currentDist += currentVel * dt;
                if (currentDist >= distAB) { currentDist = distAB; currentVel = vB; }
            } else {
                highlightStep(2);
                const distBC_sim = 6; const totalDist = distAB + distBC_sim;
                if (currentDist < totalDist) {
                    const a2 = 3.9; currentVel += a2 * dt; currentDist += currentVel * dt;
                } else {
                    currentVel = 11; simState = 'END';
                    document.getElementById('btnStart').innerText = "Finished";
                }
            }
            document.getElementById('velDisplay').innerText = currentVel.toFixed(2);
            updateBars();
        }
        
        function highlightStep(id) {
            document.querySelectorAll('.step-box').forEach(el => { if(el.id) el.classList.remove('active'); });
            let step = document.getElementById('step'+id); if(step) step.classList.add('active');
        }

        function updateBars() {
            const maxE = 5200;
            let ke = 0.5 * mass * currentVel * currentVel;
            let work = 0;
            if (currentDist <= distAB) {
                work = 48 * currentDist;
            } else {
                work = 240 + (120 * (currentDist - distAB)/6); 
            }
            let pe = maxE - ke - work; 
            if (pe < 0) pe = 0;
            
            // Stacked Bar Logic
            // KE (Green) is at start? No, PE (Red) first.
            // Total width 100%.
            // Left: PE (Red), Middle: KE (Green), Right: Work (Grey)
            
            let pePct = (pe / maxE) * 100;
            let kePct = (ke / maxE) * 100;
            let wkPct = (work / maxE) * 100;
            
            document.getElementById('barPE').style.width = pePct + "%";
            document.getElementById('barKE').style.width = kePct + "%";
            document.getElementById('barWork').style.width = wkPct + "%";
        }

        function drawFrame() {
            const w = canvas.width; const h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            if (!path.Ax) initPath();
            const { Ax, Ay, Bx, By, Cx, Cy } = path;
            
            // Draw Track (Solid)
            ctx.beginPath();
            ctx.moveTo(Ax, Ay); ctx.lineTo(Bx, By);
            const cpX = Bx + (Cx-Bx)*0.3; const cpY = Cy;
            ctx.quadraticCurveTo(cpX, Cy, Cx, Cy);
            ctx.lineTo(Cx, h); ctx.lineTo(Ax, h); ctx.closePath();
            ctx.fillStyle = '#ecf0f1'; ctx.fill();
            
            ctx.strokeStyle = '#7f8c8d'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(Ax, Ay); ctx.lineTo(Bx, By); ctx.quadraticCurveTo(cpX, Cy, Cx, Cy); ctx.stroke();
            
            // Man
            let mx, my, angle;
            if (currentDist <= distAB) {
                let p = currentDist / distAB; if (p > 1) p = 1;
                mx = Ax + (Bx - Ax) * p; my = Ay + (By - Ay) * p;
                angle = Math.atan2(By - Ay, Bx - Ax);
            } else {
                let p = (currentDist - distAB) / 6; if (p > 1) p = 1; if (p < 0) p = 0;
                let t = p; let invT = 1-t;
                let cpX = Bx + (Cx-Bx)*0.3; let cpY = Cy;
                mx = invT*invT*Bx + 2*invT*t*cpX + t*t*Cx;
                my = invT*invT*By + 2*invT*t*cpY + t*t*Cy;
                let nextT = t + 0.01;
                let nmx = (1-nextT)**2*Bx + 2*(1-nextT)*nextT*cpX + nextT**2*Cx;
                let nmy = (1-nextT)**2*By + 2*(1-nextT)*nextT*cpY + nextT**2*Cy;
                angle = Math.atan2(nmy - my, nmx - mx);
            }
            
            ctx.save(); ctx.translate(mx, my); ctx.rotate(angle);
            ctx.fillStyle = '#e67e22'; ctx.fillRect(-15, -30, 30, 30);
            ctx.beginPath(); ctx.arc(0, -38, 8, 0, Math.PI*2); ctx.fillStyle = '#f1c40f'; ctx.fill();
            ctx.restore();
        }

        // Safe init
        resize(); setTimeout(resize, 500);
    </script>
</body>
</html>