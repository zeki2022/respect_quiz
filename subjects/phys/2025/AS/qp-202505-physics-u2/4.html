<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Physics Q4: Swing & SHM</title>
    
    <!-- 引入公共样式 -->
    <link rel="stylesheet" href="../../../../../common/css/style.css">
    
    <!-- MathJax 配置 -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- V3.0 Compact Layout --- */
        body { 
            padding-top: 60px; 
            padding-bottom: 20px; /* 底部留白减小 */
            background-color: #f4f7f6; 
            max-width: none !important; 
            height: 100vh; /* 尝试限制在一屏内 */
            overflow-x: hidden;
        }
        
        .container {
            width: 98%; max-width: 1600px; margin: 0 auto;
            display: grid; grid-template-columns: 1fr 400px; 
            gap: 15px; /* 间距减小 */
            align-items: start;
        }
        @media (max-width: 1000px) { 
            .container { grid-template-columns: 1fr; display: block; } 
            body { height: auto; overflow-y: auto; }
        }

        .card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        
        .back-arrow {
            position: fixed; top: 15px; left: 15px; z-index: 9999;
            width: 40px; height: 40px; background: rgba(255,255,255,0.9);
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            text-decoration: none; color: #333; font-size: 24px; font-weight: bold;
            font-family: sans-serif; line-height: 1; cursor: pointer;
        }
        
        .canvas-container { 
            width: 100%; height: 0; 
            /* 【核心修改】电脑端高度改小，变宽屏，防止撑破屏幕 */
            padding-bottom: 38%; 
            position: relative; background: #fff; border: 1px solid #ddd; 
            border-radius: 8px; margin-bottom: 10px; overflow:hidden; 
            min-height: 300px;
        }
        @media (max-width: 1000px) { 
            /* 手机端保持高一点，不然不够画摆动 */
            .canvas-container { padding-bottom: 80%; } 
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .controls { display: flex; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; flex-wrap: wrap; align-items: center; border:1px solid #eee;}
        button.action-btn { background-color: #3498db; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;}
        
        .solution-panel { max-height: 85vh; overflow-y: auto; padding-right:5px;}
        .step-box { 
            border: 1px solid #e0e0e0; padding: 12px; margin-bottom: 10px; 
            background: #fff; border-radius: 8px; border-left: 4px solid #ccc;
            transition: all 0.3s; font-size: 14px;
        }
        .step-box.active { border-left: 4px solid #3498db; background: #f0f9ff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .math-eq { 
            font-family: 'Times New Roman', serif; font-size: 1.1em;
            color: #2c3e50; background: #f9f9f9; border: 1px solid #eee;
            padding: 1px 4px; border-radius: 4px; margin: 2px 0; display: inline-block;
        }
        .highlight { color: #d35400; font-weight: bold; }
        
        /* 题目文字紧凑点 */
        .problem-text {
            background:#e8f4fd; padding:10px; border-left:4px solid #3498db; 
            margin-bottom:10px; font-size:14px; line-height:1.5; color:#333;
        }
    </style>
</head>
<body>

    <a href="javascript:history.back()" class="back-arrow">‹</a>

    <div class="container">
        <!-- 左侧：动画演示 -->
        <div class="left-col">
            <div class="card">
                <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:10px; font-size:18px;">9708 Physics / Unit 2 / Q4</h3>
                
                <div class="problem-text">
                    <strong>Scenario:</strong> Child on swing (COM $C$). Fig 4 shows $h$ vs $t$. Damped.<br>
                    <strong>04.1</strong> Find $T$. <strong>04.2</strong> Estimate $L$. <strong>04.4</strong> Sketch KE vs $t$.
                </div>

                <div class="canvas-container">
                    <canvas id="simCanvas"></canvas>
                    <div style="position:absolute; top:10px; left:10px; font-family:monospace; color:#555; background:rgba(255,255,255,0.8); padding:4px; border-radius:4px; font-size:12px;">
                        Time: <span id="timerDisplay">0.00</span> s<br>
                        KE: <span id="keDisplay">0</span> %
                    </div>
                </div>

                <div class="controls">
                    <button class="action-btn" onclick="startSim()" id="btnStart">Start Swing</button>
                    <button class="action-btn" style="background:#95a5a6" onclick="resetSim()">Reset</button>
                    
                    <div style="flex:1; display:flex; align-items:center; justify-content:flex-end; gap:10px;">
                        <span style="font-weight:bold; color:#555; font-size:13px;">Speed:</span>
                        <input type="range" id="speedRange" min="0.1" max="2.0" step="0.1" value="0.5" style="width:100px; cursor:pointer;">
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：解题步骤 -->
        <div class="right-col">
            <div class="card solution-panel">
                
                <div id="step1" class="step-box">
                    <strong>04.1 Time Period (2 marks)</strong><br>
                    From Graph (Peaks at $t=0, 2.5, 5.0$):<br>
                    <span class="math-eq highlight">$T = 2.5$ s</span>
                </div>

                <div id="step2" class="step-box">
                    <strong>04.2 Calculate Length (2 marks)</strong><br>
                    Simple pendulum approx:<br>
                    $T = 2\pi \sqrt{\frac{L}{g}} \Rightarrow L = g (\frac{T}{2\pi})^2$<br>
                    $L = 9.81 \times (\frac{2.5}{2\pi})^2$<br>
                    <span class="math-eq highlight">$L \approx 1.55$ m</span> (Accept 1.6)
                </div>

                <div class="step-box">
                    <strong>04.3 Real vs Ideal (1 mark)</strong><br>
                    Not simple pendulum because:<br>
                    1. <strong>Damped</strong> (Air resistance)<br>
                    2. <strong>Not point mass</strong> (Child+Chain)<br>
                    3. <strong>Large angle</strong> ($> 10^\circ$)
                </div>

                <div id="step4" class="step-box">
                    <strong>04.4 Sketch KE vs t (3 marks)</strong><br>
                    1. <strong>Sinusoidal shape</strong> (always +ve)<br>
                    2. <strong>Freq = 2f</strong> (Max KE twice per T)<br>
                    Max at $1.25, 3.75$s; Min at $0, 2.5$s.<br>
                    3. <strong>Damping:</strong> Peaks decrease.
                </div>

            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        
        // Physics Vars
        const g = 9.81;
        const L_sim = 1.6; 
        const T_sim = 2.5; 
        
        // State
        let simState = 'RESET';
        let animId;
        let time = 0;
        let timeScale = 0.5;
        const decay = 0.1; 
        
        // Layout Vars
        let pivotX, pivotY, scalePx;

        document.getElementById('speedRange').addEventListener('input', (e) => {
            timeScale = parseFloat(e.target.value);
        });

        function resize() {
            if(!canvas.parentElement) return;
            canvas.width = canvas.parentElement.clientWidth;
            // 强制重算高度
            canvas.height = canvas.parentElement.clientHeight || 400;
            initScene();
            drawFrame();
        }
        window.addEventListener('resize', resize);

        function initScene() {
            const w = canvas.width;
            const h = canvas.height;
            pivotX = w / 2;
            pivotY = h * 0.1;
            // 动态比例：保证摆动不撞底
            // 高度的 75% 用来画绳子长度
            scalePx = (h * 0.75) / L_sim; 
            if (scalePx === 0 || isNaN(scalePx)) scalePx = 150;
        }

        function startSim() {
            if(simState === 'RUNNING') return;
            simState = 'RUNNING';
            document.getElementById('btnStart').disabled = true;
            let lastTime = performance.now();
            function loop(now) {
                if(simState !== 'RUNNING') return;
                let dt = (now - lastTime) / 1000;
                lastTime = now;
                if(dt > 0.1) dt = 0.1;
                
                time += dt * timeScale;
                updateSteps();
                drawFrame();
                
                document.getElementById('timerDisplay').innerText = time.toFixed(2);
                animId = requestAnimationFrame(loop);
            }
            animId = requestAnimationFrame(loop);
        }

        function resetSim() {
            cancelAnimationFrame(animId);
            simState = 'RESET';
            time = 0;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').innerText = "Start Swing";
            document.getElementById('timerDisplay').innerText = "0.00";
            document.querySelectorAll('.step-box').forEach(el => el.classList.remove('active'));
            initScene();
            drawFrame();
        }
        
        function updateSteps() {
            if (time < 1.0) highlightStep(1);
            else if (time < 2.0) highlightStep(2);
            else highlightStep(4);
        }
        
        function highlightStep(id) {
            document.querySelectorAll('.step-box').forEach(el => {
                if(el.id) el.classList.remove('active');
            });
            let step = document.getElementById('step'+id);
            if(step) step.classList.add('active');
        }

        function drawFrame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!pivotX) initScene();

            const theta0 = 0.7; // Initial angle rad
            const omega = 2 * Math.PI / T_sim;
            
            // Damped angle
            let currentTheta = theta0 * Math.exp(-decay * time) * Math.cos(omega * time);
            
            // Visual KE
            let keNorm = Math.pow(Math.sin(omega * time), 2) * Math.exp(-2*decay*time) * 100;
            document.getElementById('keDisplay').innerText = Math.round(keNorm);

            const lenPx = L_sim * scalePx;
            const bobX = pivotX + lenPx * Math.sin(currentTheta);
            const bobY = pivotY + lenPx * Math.cos(currentTheta);
            
            // Pivot
            ctx.beginPath(); ctx.moveTo(pivotX - 30, pivotY); ctx.lineTo(pivotX + 30, pivotY);
            ctx.strokeStyle = '#333'; ctx.lineWidth = 4; ctx.stroke();
            
            // String
            ctx.beginPath(); ctx.moveTo(pivotX, pivotY); ctx.lineTo(bobX, bobY);
            ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.stroke();
            
            // Bob
            ctx.beginPath(); ctx.arc(bobX, bobY, 15, 0, Math.PI*2);
            ctx.fillStyle = '#e67e22'; ctx.fill(); ctx.stroke();
            
            // KE Bar (Compact)
            const barW = 15; const barH = canvas.height * 0.4; 
            const barX = canvas.width - 30; const barY = canvas.height - 20;
            ctx.fillStyle = '#eee'; ctx.fillRect(barX, barY - barH, barW, barH);
            const fillH = (keNorm / 100) * barH;
            ctx.fillStyle = '#2ecc71'; ctx.fillRect(barX, barY - fillH, barW, fillH);
            ctx.fillStyle = '#333'; ctx.font = '10px Arial'; ctx.textAlign = 'center';
            ctx.fillText("KE", barX + barW/2, barY - barH - 5);
            
            // Height Line
            ctx.beginPath(); ctx.setLineDash([5, 5]);
            ctx.moveTo(0, bobY); ctx.lineTo(canvas.width, bobY);
            ctx.strokeStyle = 'rgba(52, 152, 219, 0.3)'; ctx.lineWidth = 1; ctx.stroke(); ctx.setLineDash([]);
        }

        // Safe init
        resize();
        setTimeout(resize, 500);
    </script>
</body>
</html>